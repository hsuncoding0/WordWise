<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Â§öÂäüËÉΩËã±ÊñáÂ≠óÂÖ∏Êü•Ë©¢</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#1f2937" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(to right, #eef2f3, #8e9eab);
      color: #333;
      margin: 0;
      padding: 1em;
      transition: background 0.5s, color 0.5s;
    }

    .dark-mode {
      background: #1e1e1e;
      color: #eee;
    }

    .container {
      max-width: 800px;
      margin: auto;
      background: white;
      border-radius: 12px;
      padding: 2em;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      transition: background 0.5s, color 0.5s;
    }

    .dark-mode .container {
      background: #2c2c2c;
    }

    h1 {
      text-align: center;
      color: #4a5568;
    }

    input[type="text"] {
      width: 80%;
      padding: 10px;
      font-size: 1.1em;
      border-radius: 8px;
      border: 1px solid #ccc;
      transition: box-shadow 0.3s;
    }

    input:focus {
      outline: none;
      box-shadow: 0 0 8px #aaa;
    }

    button {
      padding: 10px 20px;
      margin-left: 10px;
      font-size: 1em;
      border: none;
      border-radius: 8px;
      background: #4a90e2;
      color: white;
      cursor: pointer;
    }

    .dark-mode button {
      background: #007acc;
    }

    .result {
      margin-top: 2em;
      line-height: 1.6;
      font-size: 1.1em;
    }

    .history, .favorites, .suggestions {
      margin-top: 1.5em;
    }

    .history span, .favorites span, .suggestions span {
      display: inline-block;
      margin: 4px;
      background: #dfe6e9;
      padding: 5px 10px;
      border-radius: 20px;
      cursor: pointer;
    }

    .dark-mode .history span,
    .dark-mode .favorites span,
    .dark-mode .suggestions span {
      background: #555;
      color: #eee;
    }

    .phonetics, .part-of-speech, .chinese {
      margin-top: 1em;
      font-weight: bold;
    }

    .mode-toggle {
      float: right;
      cursor: pointer;
      font-size: 0.9em;
      color: #666;
    }

    audio {
      margin-top: 10px;
    }

    .loading {
      font-style: italic;
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0% {opacity: 0.2;}
      50% {opacity: 1;}
      100% {opacity: 0.2;}
    }
  </style>
</head>
<body>
  <div class="mode-toggle" onclick="toggleDarkMode()">üåó ÂàáÊèõÂ§úÈñìÊ®°Âºè</div>
  <div class="container">
    <h1>Ëã±ÊñáÂñÆÂ≠óÊü•Ë©¢Â∑•ÂÖ∑</h1>
    <input type="text" id="wordInput" placeholder="Ëº∏ÂÖ•Ëã±ÊñáÂñÆÂ≠ó" oninput="showSuggestions()">
    <button onclick="lookup()">Êü•Ë©¢</button>
    <div class="suggestions" id="suggestions"></div>
    <div class="result" id="result"></div>
    <div class="chinese" id="chinese"></div>
    <div class="history" id="history"></div>
    <div class="favorites" id="favorites"></div>
  </div>

  <script>
    const wordInput = document.getElementById("wordInput");
    const resultDiv = document.getElementById("result");
    const chineseDiv = document.getElementById("chinese");
    const historyDiv = document.getElementById("history");
    const favoritesDiv = document.getElementById("favorites");
    const suggestionsDiv = document.getElementById("suggestions");

    let wordList = ["apple", "banana", "cat", "dog", "elephant", "egypt", "zebra", "zoom", "zero"];

    function toggleDarkMode() {
      document.body.classList.toggle("dark-mode");
    }

    function speak(text) {
      const utter = new SpeechSynthesisUtterance(text);
      speechSynthesis.speak(utter);
    }

    function showSuggestions() {
      const query = wordInput.value.toLowerCase();
      if (!query) {
        suggestionsDiv.innerHTML = "";
        return;
      }
      const matches = wordList.filter(w => w.startsWith(query));
      suggestionsDiv.innerHTML = matches.map(w =>
        `<span onclick="selectSuggestion('${w}')">${w}</span>`
      ).join("");
    }

    function selectSuggestion(word) {
      wordInput.value = word;
      suggestionsDiv.innerHTML = "";
      lookup();
    }

    function renderHistory() {
      let history = JSON.parse(localStorage.getItem("history") || "[]");
      if (!history.length) {
        historyDiv.innerHTML = "";
        historyDiv.style.display = "none";
        return;
      }
      historyDiv.style.display = "block";
      historyDiv.innerHTML = "<h3>Êü•Ë©¢Á¥ÄÈåÑ</h3>" +
        history.map(w => `<span onclick="lookupWord('${w}')">${w}</span>`).join("");
    }

    function renderFavorites() {
      let fav = JSON.parse(localStorage.getItem("favorites") || "[]");
      if (!fav.length) {
        favoritesDiv.innerHTML = "";
        favoritesDiv.style.display = "none";
        return;
      }
      favoritesDiv.style.display = "block";
      favoritesDiv.innerHTML = "<h3>Êî∂ËóèÂñÆÂ≠ó</h3>" +
        fav.map(w => `<span onclick="lookupWord('${w}')">${w}</span>`).join("");
    }

    async function lookup() {
      const word = wordInput.value.trim();
      if (!word) return;
      resultDiv.innerHTML = "<div class='loading'>ËºâÂÖ•‰∏≠...</div>";
      chineseDiv.innerHTML = "";
      suggestionsDiv.innerHTML = "";

      let history = JSON.parse(localStorage.getItem("history") || "[]");
      if (!history.includes(word)) {
        history.unshift(word);
        localStorage.setItem("history", JSON.stringify(history.slice(0, 30)));
      }

      try {
        const res = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${word}`);
        const data = await res.json();
        if (!Array.isArray(data)) throw new Error();

        let html = `<h2>${data[0].word} <button onclick="speak('${data[0].word}')">üîä</button>
                    <button onclick="addFavorite('${data[0].word}')">‚≠ê Êî∂Ëóè</button></h2>`;

        const phon = data[0].phonetics.find(p => p.text || p.audio);
        if (phon) {
          html += `<div class="phonetics">${phon.text || ""}
                   ${phon.audio ? `<audio controls src="${phon.audio}"></audio>` : ""}</div>`;
        }

        data[0].meanings.forEach(m => {
          if (!m.definitions.length) return;
          html += `<div class="part-of-speech">${m.partOfSpeech}</div><ul>`;
          m.definitions.slice(0, 3).forEach(d => {
            if (d.definition) html += `<li>${d.definition}</li>`;
          });
          html += `</ul>`;
        });

        resultDiv.innerHTML = html;

        // ÁøªË≠Ø‰∏≠Êñá
        try {
          const zhRes = await fetch(`https://translate.googleapis.com/translate_a/single?client=gtx&sl=en&tl=zh-TW&dt=t&q=${encodeURIComponent(word)}`);
          const zhData = await zhRes.json();
          const zh = zhData[0][0][0];
          if (zh) chineseDiv.innerHTML = `<strong>‰∏≠ÊñáÁøªË≠ØÔºö</strong> ${zh}`;
        } catch {}

      } catch (err) {
        resultDiv.innerHTML = "‚ùå ÁÑ°Ê≥ïÂèñÂæóÂÆöÁæ©Ë≥áÊñô";
      }

      renderHistory();
      renderFavorites();
    }

    function lookupWord(word) {
      wordInput.value = word;
      lookup();
    }

    function addFavorite(word) {
      let fav = JSON.parse(localStorage.getItem("favorites") || "[]");
      if (!fav.includes(word)) {
        fav.unshift(word);
        localStorage.setItem("favorites", JSON.stringify(fav.slice(0, 50)));
        renderFavorites();
      }
    }

    // ÂàùÂßãÂåñ
    renderHistory();
    renderFavorites();
  </script>
  <script>
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js').then(reg => {
      console.log('‚úÖ Service Worker Ë®ªÂÜäÊàêÂäü', reg);
    }).catch(err => {
      console.warn('‚ùå Service Worker Ë®ªÂÜäÂ§±Êïó', err);
    });
  }
</script>
</body>
</html>
